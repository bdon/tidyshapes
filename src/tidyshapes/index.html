<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>tidyshapes</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.css">
<script src="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, -apple-system, sans-serif; height: 100vh; display: flex; }
#sidebar {
  width: 320px; flex-shrink: 0; display: flex; flex-direction: column;
  border-right: 1px solid #e0e0e0; background: #fff;
}
#sidebar header {
  padding: 16px; border-bottom: 1px solid #e0e0e0;
}
#sidebar header h1 {
  font-size: 13px; font-weight: 500; letter-spacing: 0.02em;
  text-transform: lowercase; color: #000; margin-bottom: 12px;
}
#q {
  width: 100%; padding: 7px 0; font-size: 13px; font-family: inherit;
  border: none; border-bottom: 1px solid #d0d0d0; outline: none;
  background: transparent; color: #000;
}
#q::placeholder { color: #aaa; }
#q:focus { border-bottom-color: #000; }
#count {
  padding: 8px 16px; font-size: 11px; color: #999;
  border-bottom: 1px solid #e0e0e0; flex-shrink: 0;
}
#list {
  flex: 1; overflow-y: auto;
}
.item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 7px 16px; border-bottom: 1px solid #f0f0f0;
  font-size: 13px; color: #333;
}
.item .name {
  flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.item .action {
  color: #bbb; font-size: 11px; cursor: pointer; flex-shrink: 0;
  margin-left: 12px; letter-spacing: 0.03em;
  transition: color 0.15s;
}
.item .action:hover { color: #000; }
.item.active { background: #f7f7f7; }
.item.active .name { color: #000; font-weight: 500; }
.item.active .action { color: #000; }
#map { flex: 1; }
</style>
</head>
<body>
<div id="sidebar">
  <header>
    <h1>tidyshapes</h1>
    <input type="text" id="q" placeholder="filter" autocomplete="off" spellcheck="false">
  </header>
  <div id="count"></div>
  <div id="list"></div>
</div>
<div id="map"></div>
<script>
let slugs = [];
let selected = null;
const base = location.hash.slice(1) || '.';

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://demotiles.maplibre.org/style.json',
  center: [0, 20], zoom: 2
});
map.on('load', () => {
  map.addSource('bbox', {type:'geojson', data:{type:'FeatureCollection', features:[]}});
  map.addLayer({id:'bbox-fill', type:'fill', source:'bbox',
    paint:{'fill-color':'#000','fill-opacity':0.06}});
  map.addLayer({id:'bbox-line', type:'line', source:'bbox',
    paint:{'line-color':'#000','line-width':1.5}});
});

const listEl = document.getElementById('list');
const countEl = document.getElementById('count');
const input = document.getElementById('q');

function render(filtered) {
  countEl.textContent = filtered.length.toLocaleString() + ' entries';
  listEl.innerHTML = '';
  for (const slug of filtered) {
    const row = document.createElement('div');
    row.className = 'item' + (slug === selected ? ' active' : '');
    row.innerHTML = '<span class="name"></span><span class="action">bbox</span>';
    row.querySelector('.name').textContent = slug;
    row.querySelector('.action').onclick = (e) => { e.stopPropagation(); select(slug, row); };
    listEl.appendChild(row);
  }
}

function filter() {
  const q = input.value.toLowerCase().replace(/\s+/g, '-');
  const filtered = q ? slugs.filter(s => s.startsWith(q)) : slugs;
  render(filtered);
}

async function select(slug, row) {
  selected = slug;
  document.querySelectorAll('.item.active').forEach(el => el.classList.remove('active'));
  row.classList.add('active');
  const text = await fetch(base + '/' + slug + '.bbox').then(r => r.text());
  const [minx, miny, maxx, maxy] = text.trim().split(',').map(Number);
  map.getSource('bbox').setData({type:'Feature', geometry:{type:'Polygon',
    coordinates:[[[minx,miny],[maxx,miny],[maxx,maxy],[minx,maxy],[minx,miny]]]}});
  map.fitBounds([[minx, miny], [maxx, maxy]], {padding: 50});
}

input.addEventListener('input', filter);

fetch(base + '/index.csv').then(r => r.text()).then(t => {
  slugs = t.trim().split('\n');
  render(slugs);
});
</script>
</body>
</html>
