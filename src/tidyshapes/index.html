<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>tidyshapes</title>
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.css">
<script src="https://unpkg.com/maplibre-gl@5.18.0/dist/maplibre-gl.js"></script>
<style>
:root {
  --bg: #fff; --fg: #333; --fg-strong: #000;
  --border: #e0e0e0; --border-subtle: #f0f0f0;
  --muted: #999; --action: #bbb; --active-bg: #f7f7f7;
  --placeholder: #aaa; --input-border: #d0d0d0;
}
@media (prefers-color-scheme: dark) { :root {
  --bg: #1a1a1a; --fg: #aaa; --fg-strong: #ddd;
  --border: #2e2e2e; --border-subtle: #252525;
  --muted: #666; --action: #555; --active-bg: #242424;
  --placeholder: #555; --input-border: #444;
}}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, -apple-system, sans-serif; height: 100vh; display: flex; }
#sidebar {
  width: 360px; flex-shrink: 0; display: flex; flex-direction: column;
  border-right: 1px solid var(--border); background: var(--bg);
}
#sidebar header { padding: 16px; border-bottom: 1px solid var(--border); }
#sidebar header h1 {
  font-size: 13px; font-weight: 500; letter-spacing: 0.02em;
  text-transform: lowercase; color: var(--fg-strong); margin-bottom: 12px;
}
#q {
  width: 100%; padding: 7px 0; font-size: 13px; font-family: inherit;
  border: none; border-bottom: 1px solid var(--input-border); outline: none;
  background: transparent; color: var(--fg-strong);
}
#q::placeholder { color: var(--placeholder); }
#q:focus { border-bottom-color: var(--fg-strong); }
#count {
  padding: 8px 16px; font-size: 11px; color: var(--muted);
  border-bottom: 1px solid var(--border); flex-shrink: 0;
}
#list { flex: 1; overflow-y: auto; }
.item {
  display: flex; align-items: center;
  padding: 7px 16px; border-bottom: 1px solid var(--border-subtle);
  font-size: 13px; color: var(--fg);
}
.item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.item .actions {
  display: flex; align-items: center; gap: 6px;
  flex-shrink: 0; margin-left: 12px; font-size: 11px; letter-spacing: 0.03em;
}
.item .actions .sep {
  width: 1px; height: 10px; background: var(--border);
}
.item .actions span[data-action] {
  color: var(--action); cursor: pointer; transition: color 0.15s;
}
.item .actions span[data-action]:hover { color: var(--fg-strong); }
.item.active { background: var(--active-bg); }
.item.active .name { color: var(--fg-strong); font-weight: 500; }
.item.active .actions span[data-action] { color: var(--muted); }
.item.active .actions span[data-action]:hover { color: var(--fg-strong); }
#map { flex: 1; }
.maplibregl-ctrl-attrib {
  background: transparent !important; font-size: 11px !important;
}
.maplibregl-ctrl-attrib, .maplibregl-ctrl-attrib a {
  color: var(--muted) !important;
}
.maplibregl-ctrl-attrib a:hover { color: var(--fg-strong) !important; }
</style>
</head>
<body>
<div id="sidebar">
  <header>
    <h1>tidyshapes</h1>
    <input type="text" id="q" placeholder="filter" autocomplete="off" spellcheck="false">
  </header>
  <div id="count"></div>
  <div id="list"></div>
</div>
<div id="map"></div>
<script>
const API_KEY = 'a31ac650e89b2a1d';
const VISIBLE_LIMIT = 200;
let slugs = [];
let selected = null;
let debounceTimer;
const dark = window.matchMedia('(prefers-color-scheme: dark)').matches;
const bboxColor = dark ? '#fff' : '#000';

const map = new maplibregl.Map({
  container: 'map',
  style: 'https://api.protomaps.com/styles/v5/' + (dark ? 'black' : 'white') + '/en.json?key=' + API_KEY,
  center: [0, 20], zoom: 2,
  attributionControl: false
});
map.addControl(new maplibregl.AttributionControl({compact: false,
  customAttribution: '<a href="https://overturemaps.org">Overture Maps Foundation</a>'
}));
map.on('load', () => {
  map.addSource('bbox', {type:'geojson', data:{type:'FeatureCollection', features:[]}});
  map.addLayer({id:'bbox-fill', type:'fill', source:'bbox',
    paint:{'fill-color':bboxColor,'fill-opacity':0.06}});
  map.addLayer({id:'bbox-line', type:'line', source:'bbox',
    paint:{'line-color':bboxColor,'line-width':1.5}});
});

const listEl = document.getElementById('list');
const countEl = document.getElementById('count');
const input = document.getElementById('q');

function render(filtered) {
  const total = filtered.length;
  const shown = Math.min(total, VISIBLE_LIMIT);
  countEl.textContent = shown < total
    ? shown.toLocaleString() + ' of ' + total.toLocaleString() + ' entries'
    : total.toLocaleString() + ' entries';
  const parts = [];
  for (let i = 0; i < shown; i++) {
    const slug = filtered[i];
    const cls = slug === selected ? 'item active' : 'item';
    parts.push('<div class="' + cls + '" data-slug="' + slug + '">'
      + '<span class="name">' + slug + '</span>'
      + '<span class="actions">'
      + '<span data-action="1k">1k</span>'
      + '<span data-action="10k">10k</span>'
      + '<span class="sep"></span>'
      + '<span data-action="bbox">bbox</span>'
      + '</span></div>');
  }
  listEl.innerHTML = parts.join('');
}

function filter() {
  const q = input.value.toLowerCase().replace(/\s+/g, '-');
  const filtered = q ? slugs.filter(s => s.startsWith(q)) : slugs;
  render(filtered);
}

listEl.addEventListener('click', (e) => {
  const actionEl = e.target.closest('[data-action]');
  if (!actionEl) return;
  const row = actionEl.closest('.item');
  if (!row) return;
  selectAction(row.dataset.slug, row, actionEl.dataset.action);
});

async function selectAction(slug, row, action) {
  selected = slug;
  const prev = listEl.querySelector('.item.active');
  if (prev) prev.className = 'item';
  row.className = 'item active';
  if (action === 'bbox') {
    const text = await fetch(slug + '.bbox').then(r => r.text());
    const [minx, miny, maxx, maxy] = text.trim().split(',').map(Number);
    map.getSource('bbox').setData({type:'Feature', geometry:{type:'Polygon',
      coordinates:[[[minx,miny],[maxx,miny],[maxx,maxy],[minx,maxy],[minx,miny]]]}});
    map.fitBounds([[minx, miny], [maxx, maxy]], {padding: 50, animate: false});
  } else {
    const geojson = await fetch(slug + '.' + action + '.geojson').then(r => r.json());
    map.getSource('bbox').setData({type:'Feature', geometry: geojson});
    const [minx, miny, maxx, maxy] = shapely_bounds(geojson.coordinates);
    map.fitBounds([[minx, miny], [maxx, maxy]], {padding: 50, animate: false});
  }
}

function shapely_bounds(coords) {
  let minx = Infinity, miny = Infinity, maxx = -Infinity, maxy = -Infinity;
  const stack = [coords];
  while (stack.length) {
    const c = stack.pop();
    if (typeof c[0] === 'number') { minx = Math.min(minx,c[0]); miny = Math.min(miny,c[1]); maxx = Math.max(maxx,c[0]); maxy = Math.max(maxy,c[1]); }
    else for (const item of c) stack.push(item);
  }
  return [minx, miny, maxx, maxy];
}

input.addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(filter, 80);
});
input.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;
  const first = listEl.querySelector('.item');
  if (first) selectAction(first.dataset.slug, first, '1k');
});

fetch('index.csv').then(r => r.text()).then(t => {
  slugs = t.trim().split('\n');
  render(slugs);
});
</script>
</body>
</html>
